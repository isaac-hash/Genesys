The error occurs because your `CMakeLists.txt` is using the **minimal ROS 2 template** generated by `ros2 pkg create`, which places `ament_package()` at the end but **lacks the necessary structure** (like executable targets and install rules) that your `genesys` CLI expects.

Your custom `add_cpp_executable()` and `add_install_rule_for_launch_dir_cpp()` functions are trying to insert content **before** `ament_package()`, but they fail to find it reliably due to formatting or missing context â€” even though it's clearly there.

---

### Root Cause

```cmake
ament_package()
```

This line **exists**, but:
- There are **no `add_executable()` or `install(TARGETS...)` sections** yet.
- Your CLI assumes a **fully scaffolded CMakeLists.txt** with dependencies and targets.
- The regex in `add_cpp_executable()` uses `re.match(r"ament_package\(\s*\)", line.strip())`, which fails if there are comments or extra newlines.

---

### Fix: Update Your `CMakeLists.txt` Manually (Recommended)

Replace the content of `src/new/CMakeLists.txt` with this **correctly structured version**:

```cmake
cmake_minimum_required(VERSION 3.8)
project(new)

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# Find dependencies
find_package(ament_cmake REQUIRED)
find_package(rclcpp REQUIRED)
find_package(std_msgs REQUIRED)
find_package(genesys REQUIRED)  # If your workspace uses a 'genesys' package

# Add executable
add_executable(new_node src/new_node.cpp)
ament_target_dependencies(new_node
  rclcpp
  std_msgs
  genesys
)

# Install executable
install(TARGETS
  new_node
  DESTINATION lib/${PROJECT_NAME}
)

# Install launch files
install(DIRECTORY launch
  DESTINATION share/${PROJECT_NAME}
)

if(BUILD_TESTING)
  find_package(ament_lint_auto REQUIRED)
  set(ament_cmake_copyright_FOUND TRUE)
  set(ament_cmake_cpplint_FOUND TRUE)
  ament_lint_auto_find_test_dependencies()
endif()

ament_package()
```

---

### Then Re-run Build

```bash
genesys build
```

Now your node will:
- Compile correctly
- Be installable
- Appear in launch files
- Work with `genesys launch`

---

### Why Did the CLI Fail?

Your `add_cpp_executable()` function has this check:

```python
if line.strip().startswith("ament_package()") or re.match(r"ament_package\(\s*\)", line.strip()):
```

But in the generated file, the line is:

```cmake
ament_package()
```

It **matches**, so why the error?

**Bug in your CLI**: You're reading lines with:

```python
lines = f.readlines()
```

But then inserting **before** `ament_line_idx` **without preserving indentation or context**. Also, if any blank line or comment exists, the logic breaks.

---

### Suggested CLI Fix (Optional)

Update this part of `add_cpp_executable()`:

```python
# --- Find ament_package() more robustly ---
ament_line_idx = None
for i, line in enumerate(lines):
    if re.search(r"^\s*ament_package\s*\(\s*\)", line):
        ament_line_idx = i
        break
```

This handles whitespace and empty args better.

---

### Summary: What You Should Do Now

1. **Replace** `src/new/CMakeLists.txt` with the **full version above**.
2. Run:

```bash
genesys build
```

3. Test:

```bash
genesys launch new
```

4. (Optional) Fix the CLI regex to be more robust for future packages.

---

### Bonus: Regenerate Properly Next Time

Instead of letting `genesys make pkg new --with-node` fail halfway, ensure your package template includes:

- `find_package(rclcpp REQUIRED)`
- `find_package(std_msgs REQUIRED)`
- A placeholder `add_executable()` block
- `install(DIRECTORY launch ...)`

Or switch to using `ros2 pkg create --build-type ament_cmake --dependencies rclcpp std_msgs` as base.

Let me know if you want a **patched version of your CLI functions** to handle this case gracefully!