
import os
from ament_index_python.packages import get_package_share_directory
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument, IncludeLaunchDescription, GroupAction
from launch.launch_description_sources import PythonLaunchDescriptionSource
from launch.substitutions import LaunchConfiguration, PathJoinSubstitution
from launch_ros.actions import PushRosNamespace, Node

def generate_launch_description():
    # Arguments
    namespace = LaunchConfiguration('namespace')
    use_sim_time = LaunchConfiguration('use_sim_time')
    
    # Packages
    pkg_nav2_bringup = get_package_share_directory('nav2_bringup')
    pkg_slam_toolbox = get_package_share_directory('slam_toolbox')
    
    # Path to our own params
    # Assuming this file sits in <robot_name>_navigation/launch/
    # And params are in <robot_name>_navigation/config/
    # In a real installed generic sense, we'd look up the package share.
    # For generated code, we can assume relative or package lookup if installed.
    # We will assume package lookup for robustness.
    pkg_share = get_package_share_directory('{{ config.robot_name }}_navigation')
    nav2_params_file = os.path.join(pkg_share, 'config', 'nav2_params.yaml')

    return LaunchDescription([
        DeclareLaunchArgument(
            'namespace',
            default_value='',
            description='Top-level namespace'),
            
        DeclareLaunchArgument(
            'use_sim_time',
            default_value='{{ use_sim_time }}',
            description='Use simulation (Gazebo) clock if true'),

        DeclareLaunchArgument(
            'params_file',
            default_value=nav2_params_file,
            description='Full path to the ROS2 parameters file to use for all launched nodes'),

        # Group for namespacing
        GroupAction(
            actions=[
                PushRosNamespace(namespace),
                
                # Robot State Publisher (URDF)
                IncludeLaunchDescription(
                    PythonLaunchDescriptionSource(os.path.join(
                        get_package_share_directory('{{ config.robot_name }}_description'), 'launch', 'rsp.launch.py')),
                    launch_arguments={'use_sim_time': use_sim_time, 'namespace': namespace}.items()
                ),

                # Nav2 Bringup
                IncludeLaunchDescription(
                    PythonLaunchDescriptionSource(os.path.join(pkg_nav2_bringup, 'launch', 'navigation_launch.py')),
                    launch_arguments={
                        'use_sim_time': use_sim_time,
                        'params_file': LaunchConfiguration('params_file'),
                        'container_name': 'nav2_container',
                        'namespace': namespace,
                        'use_composition': 'True', # Best practice
                        'autostart': 'True'
                    }.items()
                ),
                
                # SLAM Toolbox (if desired, or map_server if map provided)
                # For Phase 2 we default to SLAM for "core generation" to get up and running 
                # or we could make it conditional. Sticking to SLAM for autonomy base.
                IncludeLaunchDescription(
                     PythonLaunchDescriptionSource(os.path.join(pkg_slam_toolbox, 'launch', 'online_async_launch.py')),
                     launch_arguments={
                         'use_sim_time': use_sim_time,
                         'params_file': LaunchConfiguration('params_file') # Reuse same params if possible, or split
                     }.items()
                )
            ]
        )
    ])
