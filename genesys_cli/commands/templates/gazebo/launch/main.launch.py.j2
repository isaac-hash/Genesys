from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument, IncludeLaunchDescription, SetEnvironmentVariable
from launch.launch_description_sources import PythonLaunchDescriptionSource
from launch.substitutions import LaunchConfiguration, PathJoinSubstitution
from launch_ros.actions import Node
from launch_ros.substitutions import FindPackageShare
import os


def generate_launch_description():
    # ------------------------------------------------------------------ #
    # Packages
    # ------------------------------------------------------------------ #
    pkg_robot = FindPackageShare('{{ package_name }}')
    pkg_ros_gz_sim = FindPackageShare('ros_gz_sim')

    # ------------------------------------------------------------------ #
    # Launch arguments
    # ------------------------------------------------------------------ #
    robot_name_arg   = DeclareLaunchArgument('robot_name', default_value='{{ robot_name }}')
    world_file_arg   = DeclareLaunchArgument('world_file', default_value='empty.world')
    x_arg            = DeclareLaunchArgument('x', default_value='0.0')
    y_arg            = DeclareLaunchArgument('y', default_value='0.0')
    z_arg            = DeclareLaunchArgument('z', default_value='0.1')
    use_sim_time_arg = DeclareLaunchArgument('use_sim_time', default_value='true')

    robot_name   = LaunchConfiguration('robot_name')
    world_file   = LaunchConfiguration('world_file')
    x            = LaunchConfiguration('x')
    y            = LaunchConfiguration('y')
    z            = LaunchConfiguration('z')
    use_sim_time = LaunchConfiguration('use_sim_time')

    # ------------------------------------------------------------------ #
    # World path
    # ------------------------------------------------------------------ #
    world_path = PathJoinSubstitution([pkg_robot, 'worlds', world_file])

    # ------------------------------------------------------------------ #
    # Gazebo model path
    # ------------------------------------------------------------------ #
    gazebo_model_path = SetEnvironmentVariable(
        name='GAZEBO_MODEL_PATH',
        value=[
            PathJoinSubstitution([os.getcwd(), 'sim', 'models']),
            os.path.expanduser('~/.gazebo/models'),
            os.getenv('GAZEBO_MODEL_PATH', '')
        ]
    )

    # ------------------------------------------------------------------ #
    # Launch Gazebo
    # ------------------------------------------------------------------ #
    gz_launch_file = PathJoinSubstitution([pkg_ros_gz_sim, 'launch', 'gz_sim.launch.py'])
    gazebo = IncludeLaunchDescription(
        PythonLaunchDescriptionSource(gz_launch_file),
        launch_arguments={'gz_args': ['-r ', world_path]}.items()
    )

    # ------------------------------------------------------------------ #
    # Clock bridge
    # ------------------------------------------------------------------ #
    clock_bridge = Node(
        package='ros_gz_bridge',
        executable='parameter_bridge',
        arguments=['/clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock]'],
        output='screen'
    )

    # ------------------------------------------------------------------ #
    # Spawn robot
    # ------------------------------------------------------------------ #
    # Hardcode the actual spawn launch filename, do NOT use LaunchConfiguration here
    spawn_launch_file = PathJoinSubstitution([
        pkg_robot, 'launch', 'spawn_{{ robot_name }}.launch.py'
    ])
    spawn_robot = IncludeLaunchDescription(
        PythonLaunchDescriptionSource(spawn_launch_file),
        launch_arguments={
            'robot_name':   robot_name,
            'x':            x,
            'y':            y,
            'z':            z,
            'use_sim_time': use_sim_time
        }.items()
    )

    # ------------------------------------------------------------------ #
    # Final LaunchDescription
    # ------------------------------------------------------------------ #
    return LaunchDescription([
        robot_name_arg,
        world_file_arg,
        x_arg,
        y_arg,
        z_arg,
        use_sim_time_arg,
        gazebo_model_path,
        gazebo,
        clock_bridge,
        spawn_robot
    ])
